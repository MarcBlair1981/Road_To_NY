<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dice Boardgame â€” 30-Day Simulator</title>
<style>
  :root { --bg:#0b0c10; --card:#11131a; --ink:#e6eef8; --muted:#9fb3c8; --accent:#5eead4; }
  * { box-sizing: border-box; }
  body { margin:0; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; color: var(--ink); background: linear-gradient(180deg,#0b0c10 0%, #0e1116 100%); }
  header { padding: 16px 20px; border-bottom: 1px solid #1d2230; }
  h1 { margin: 0; font-size: 20px; }
  main { padding: 16px; max-width: 1100px; margin: 0 auto; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .card { background: var(--card); border: 1px solid #1d2230; border-radius: 14px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center; margin-bottom: 10px; }
  label { color: var(--muted); font-size: 13px; }
  input[type="number"], input[type="text"], input[type="range"] {
    width: 100%; padding: 8px 10px; background: #0f1320; color: var(--ink);
    border: 1px solid #243047; border-radius: 10px; outline: none;
  }
  input[type="checkbox"] { transform: scale(1.2); }
  .help { color: var(--muted); font-size: 12px; margin-top: 6px; }
  .actions { display:flex; gap:10px; flex-wrap:wrap; }
  button {
    padding: 10px 14px; border-radius: 12px; border: 1px solid #294460;
    background: #0f2135; color: var(--ink); cursor: pointer; font-weight: 600;
  }
  button.primary { border-color: #1b6b63; background: #0c3a35; }
  button:disabled { opacity: .6; cursor: not-allowed; }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  th, td { border: 1px solid #243047; padding: 8px; text-align: right; }
  th { background: #0f1320; text-align: left; }
  .flex { display:flex; gap:10px; align-items:center; }
  .pill { background:#0f2135; border:1px solid #294460; padding:4px 8px; border-radius: 999px; color: var(--muted); font-size: 12px; }
  canvas { width: 100%; height: 240px; display:block; background:#0f1320; border:1px solid #243047; border-radius: 10px; }
  .footer { color: var(--muted); font-size: 12px; text-align:center; margin-top: 16px; }
  .nowrap { white-space: nowrap; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
</style>
</head>
<body>
<header>
  <h1>ðŸŽ² Dice Boardgame â€” 30-Day Simulator (No Python Needed)</h1>
</header>
<main>
  <div class="grid">
    <section class="card">
      <h2 style="margin-top:0;">Inputs</h2>
      <div class="row">
        <label for="rollsPerSession"># rolls per session</label>
        <input id="rollsPerSession" type="number" min="1" max="10" step="1" value="1" />
      </div>
      <div class="row">
        <label for="sessionsPerDay">Sessions per day</label>
        <input id="sessionsPerDay" type="number" min="1" max="24" step="1" value="1" />
      </div>
      <div class="row">
        <label for="numUsers">Expected number of users</label>
        <input id="numUsers" type="number" min="10" max="1000000" step="10" value="1000" />
      </div>
      <div class="row">
        <label for="participation">Daily participation per session (%)</label>
        <div class="flex">
          <input id="participation" type="range" min="0" max="100" step="1" value="100" />
          <span id="partVal" class="pill">100%</span>
        </div>
      </div>
      <div class="row">
        <label for="doubleSix">Double roll on six (explode)</label>
        <input id="doubleSix" type="checkbox" checked />
      </div>
      <div class="row">
        <label for="leaderboard">Show Day-30 leaderboard</label>
        <input id="leaderboard" type="checkbox" checked />
      </div>
      <div class="row">
        <label for="seed">Simulation Variant</label>
        <input id="seed" type="number" step="1" value="42" />
      </div>
      <div class="help">
        Defaults: rolls/session=1, sessions/day=1, users=1000, participation=100%, explode=ON, leaderboard=ON, seed=42.
      </div>
      <div class="actions" style="margin-top:10px;">
        <button id="run" class="primary">Run Simulation (30 days)</button>
        <button id="dlPositions" disabled>Download positions.csv</button>
        <button id="dlMilestones" disabled>Download milestones.csv</button>
        <button id="dlLeaderboard" disabled>Download leaderboard.csv</button>
      </div>
    </section>

    <section class="card">
      <h2 style="margin-top:0;">Quick Stats</h2>
      <div id="stats"></div>
      <div class="help">We show mean, std, min, quartiles, max for days 7/14/21/30 across users.</div>
    </section>
  </div>

  <section class="card" style="margin-top:16px;">
    <h2 style="margin-top:0;">Distributions (Positions after D days)</h2>
    <div class="grid">
      <div>
        <div class="flex"><span class="pill">Day 7</span><span id="count7" class="pill"></span></div>
        <canvas id="hist7" width="520" height="240"></canvas>
      </div>
      <div>
        <div class="flex"><span class="pill">Day 14</span><span id="count14" class="pill"></span></div>
        <canvas id="hist14" width="520" height="240"></canvas>
      </div>
      <div>
        <div class="flex"><span class="pill">Day 21</span><span id="count21" class="pill"></span></div>
        <canvas id="hist21" width="520" height="240"></canvas>
      </div>
      <div>
        <div class="flex"><span class="pill">Day 30</span><span id="count30" class="pill"></span></div>
        <canvas id="hist30" width="520" height="240"></canvas>
      </div>
    </div>
  </section>

  <section class="card" id="leaderboardCard" style="margin-top:16px; display:none;">
    <h2 style="margin-top:0;">Leaderboard â€” Day 30 (Top 20)</h2>
    <div id="board"></div>
  </section>

  <div class="footer">
    Method: sessions/day Ã— participation Ã— (sum of dice per session), accumulated across days. Exploding-six increases mean and variance.
  </div>
</main>

<script>
/* ---------- Utilities ---------- */
function mulberry32(a) {
  return function() {
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function randint(rng, min, maxInclusive) {
  return Math.floor(rng() * (maxInclusive - min + 1)) + min;
}
function die(rng) { return randint(rng, 1, 6); }

function rollSession(rng, rollsPerSession, explode) {
  let total = 0;
  for (let i = 0; i < rollsPerSession; i++) {
    const d = die(rng); total += d;
    if (explode && d === 6) {
      // chain until non-6
      while (true) {
        const e = die(rng); total += e;
        if (e !== 6) break;
      }
    }
  }
  return total;
}

function quantiles(arr) {
  if (arr.length === 0) return {min:0,q1:0,med:0,q3:0,max:0};
  const a = arr.slice().sort((x,y)=>x-y);
  const nth = (p) => {
    const idx = (a.length - 1) * p;
    const lo = Math.floor(idx), hi = Math.ceil(idx);
    if (lo === hi) return a[lo];
    const w = idx - lo;
    return a[lo] * (1 - w) + a[hi] * w;
  };
  return {
    min: a[0],
    q1: nth(0.25),
    med: nth(0.50),
    q3: nth(0.75),
    max: a[a.length - 1],
  };
}
function meanStd(arr) {
  const n = arr.length || 1;
  const m = arr.reduce((s,x)=>s+x,0) / n;
  const v = arr.reduce((s,x)=>s+(x-m)*(x-m),0) / Math.max(1, n-1);
  return { mean: m, std: Math.sqrt(v) };
}
function toCSV(rows, headers) {
  const esc = (v) => {
    const s = String(v ?? "");
    return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
  };
  const head = headers.join(",");
  const body = rows.map(r => headers.map(h => esc(r[h])).join(",")).join("\n");
  return head + "\n" + body;
}
function download(filename, text) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text], {type:"text/csv"}));
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ---------- Histogram drawing (simple canvas) ---------- */
function drawHist(canvas, values) {
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (!values || values.length === 0) return;

  const maxVal = Math.max(...values);
  const binCount = Math.max(10, Math.min(60, Math.floor(maxVal/2)+1));
  const bins = new Array(binCount).fill(0);
  const minVal = 0; // positions are non-negative
  const range = Math.max(1, maxVal - minVal);
  for (const v of values) {
    let b = Math.floor((v - minVal) / range * binCount);
    if (b >= binCount) b = binCount - 1;
    if (b < 0) b = 0;
    bins[b]++;
  }

  // margins
  const W = canvas.width, H = canvas.height;
  const padL = 36, padR = 10, padT = 10, padB = 24;
  const plotW = W - padL - padR, plotH = H - padT - padB;
  const maxBin = Math.max(...bins, 1);

  // axes
  ctx.strokeStyle = "#294460";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, padT);
  ctx.lineTo(padL, padT + plotH);
  ctx.lineTo(padL + plotW, padT + plotH);
  ctx.stroke();

  // bars
  const barW = plotW / binCount;
  ctx.fillStyle = "#5eead4";
  for (let i = 0; i < binCount; i++) {
    const h = (bins[i] / maxBin) * plotH;
    const x = padL + i * barW + 1;
    const y = padT + (plotH - h);
    ctx.fillRect(x, y, Math.max(1, barW - 2), h);
  }

  // simple tick labels (0, max)
  ctx.fillStyle = "#9fb3c8";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.textAlign = "right";
  ctx.fillText(String(maxBin), padL - 6, padT + 12);
  ctx.fillText("0", padL - 6, padT + plotH);
}

/* ---------- Main simulation ---------- */
const DAYS = 30;
const MILESTONES = [7,14,21,30];

function simulate(params) {
  const { users, sessionsPerDay, rollsPerSession, pPlay, explodeSix, seed } = params;
  const rng = mulberry32((seed >>> 0) || 42);

  // Pre-allocate
  const positions = Array.from({length: users}, () => new Array(DAYS).fill(0));
  const steps = new Array(users).fill(0);

  const playedSessionsPerDay = Array.from({length: users}, () => new Array(DAYS).fill(0));
  const stepsGainedPerDay = Array.from({length: users}, () => new Array(DAYS).fill(0));

  for (let d = 0; d < DAYS; d++) {
    for (let u = 0; u < users; u++) {
      let daySteps = 0;
      let played = 0;
      for (let s = 0; s < sessionsPerDay; s++) {
        if (rng() < pPlay) {
          played++;
          daySteps += rollSession(rng, rollsPerSession, explodeSix);
        }
      }
      steps[u] = steps[u] + daySteps;
      positions[u][d] = steps[u];

      playedSessionsPerDay[u][d] = played;
      stepsGainedPerDay[u][d] = daySteps;
    }
  }

  return { positions, playedSessionsPerDay, stepsGainedPerDay };
}

/* ---------- UI wiring ---------- */
const $ = (id) => document.getElementById(id);
const runBtn = $("run");
const dlPosBtn = $("dlPositions");
const dlMilBtn = $("dlMilestones");
const dlLbBtn = $("dlLeaderboard");
const partSlider = $("participation");
const partVal = $("partVal");
partSlider.addEventListener("input", () => partVal.textContent = partSlider.value + "%");
partVal.textContent = partSlider.value + "%";

let lastArtifacts = null;

runBtn.addEventListener("click", () => {
  runBtn.disabled = true;
  dlPosBtn.disabled = true; dlMilBtn.disabled = true; dlLbBtn.disabled = true;
  $("leaderboardCard").style.display = $("leaderboard").checked ? "block" : "none";
  $("stats").innerHTML = "Runningâ€¦";

  // read params
  const rollsPerSession = Math.max(1, parseInt($("rollsPerSession").value || "1", 10));
  const sessionsPerDay = Math.max(1, parseInt($("sessionsPerDay").value || "1", 10));
  const users = Math.max(1, parseInt($("numUsers").value || "1000", 10));
  const pPlay = Math.min(1, Math.max(0, parseInt(partSlider.value, 10) / 100));
  const explodeSix = $("doubleSix").checked;
  const leaderboard = $("leaderboard").checked;
  const seed = parseInt($("seed").value || "42", 10) >>> 0;

  const t0 = performance.now();
  const sim = simulate({ users, sessionsPerDay, rollsPerSession, pPlay, explodeSix, seed });
  const t1 = performance.now();

  // Build milestone stats & histograms
  const statsDiv = $("stats");
  statsDiv.innerHTML = "";
  const table = document.createElement("table");
  const header = document.createElement("tr");
  ["Day","Users","Mean","Std","Min","25%","Median","75%","Max"].forEach(h => {
    const th = document.createElement("th"); th.textContent = h; header.appendChild(th);
  });
  table.appendChild(header);

  const milestoneRows = [];
  const histTargets = {7:"hist7",14:"hist14",21:"hist21",30:"hist30"};
  const countTargets = {7:"count7",14:"count14",21:"count21",30:"count30"};

  for (const m of MILESTONES) {
    const arr = sim.positions.map(p => p[m-1]); // position at day m
    const { mean, std } = meanStd(arr);
    const { min, q1, med, q3, max } = quantiles(arr);

    const tr = document.createElement("tr");
    const cells = [m, users, mean.toFixed(2), std.toFixed(2), min, q1.toFixed(2), med.toFixed(2), q3.toFixed(2), max];
    cells.forEach((c,i) => {
      const td = document.createElement("td");
      td.textContent = c;
      if (i===0 || i===1) td.style.textAlign = "left";
      tr.appendChild(td);
    });
    table.appendChild(tr);

    milestoneRows.push({
      day: m, users, mean: mean.toFixed(6), std: std.toFixed(6),
      min, p25: q1.toFixed(6), median: med.toFixed(6), p75: q3.toFixed(6), max
    });

    // hist
    const canvas = $(histTargets[m]);
    drawHist(canvas, arr);
    $(countTargets[m]).textContent = `${arr.length} users`;
  }
  statsDiv.appendChild(table);

  // Leaderboard (day 30)
  let leaderboardRows = [];
  if (leaderboard) {
    const day30 = sim.positions.map((p,i)=>({ user_id:i+1, position:p[29] }));
    day30.sort((a,b)=>b.position - a.position);
    leaderboardRows = day30.map((r,idx)=>({ rank: idx+1, user_id: r.user_id, position: r.position }));
    const boardDiv = $("board");
    const tbl = document.createElement("table");
    const h = document.createElement("tr");
    ["Rank","User","Position"].forEach(t=>{ const th=document.createElement("th"); th.textContent=t; h.appendChild(th); });
    tbl.appendChild(h);
    leaderboardRows.slice(0,20).forEach(r=>{
      const tr = document.createElement("tr");
      const cols = [r.rank, r.user_id, r.position];
      cols.forEach((c,i)=>{ const td=document.createElement("td"); td.textContent=c; if (i===1) td.style.textAlign="left"; tr.appendChild(td); });
      tbl.appendChild(tr);
    });
    boardDiv.innerHTML = ""; boardDiv.appendChild(tbl);
  }

  // Build CSVs
  const positionsRows = [];
  for (let u=0; u<users; u++) {
    for (let d=0; d<DAYS; d++) {
      positionsRows.push({
        user_id: u+1,
        day: d+1,
        sessions_played: sim.playedSessionsPerDay[u][d],
        steps_gained: sim.stepsGainedPerDay[u][d],
        position: sim.positions[u][d],
      });
    }
  }

  const csvPositions = toCSV(positionsRows, ["user_id","day","sessions_played","steps_gained","position"]);
  const csvMilestones = toCSV(milestoneRows, ["day","users","mean","std","min","p25","median","p75","max"]);
  const csvLeaderboard = toCSV(leaderboardRows, ["rank","user_id","position"]);

  lastArtifacts = {
    csvPositions, csvMilestones, csvLeaderboard,
    filenameTag: `u${users}_k${sessionsPerDay}_r${rollsPerSession}_p${Math.round(pPlay*100)}_x${explodeSix?1:0}_seed${seed}`
  };

  // enable downloads
  dlPosBtn.disabled = false; dlMilBtn.disabled = false; dlLbBtn.disabled = !leaderboard;

  const ms = (t1 - t0).toFixed(0);
  const note = document.createElement("div");
  note.className = "help";
  note.innerHTML = `Simulated <span class="mono">${users.toLocaleString()}</span> users Ã— 30 days in <span class="nowrap">${ms} ms</span>.`;
  statsDiv.appendChild(note);

  runBtn.disabled = false;
});

dlPosBtn.addEventListener("click", () => {
  if (!lastArtifacts) return;
  download(`positions_${lastArtifacts.filenameTag}.csv`, lastArtifacts.csvPositions);
});
dlMilBtn.addEventListener("click", () => {
  if (!lastArtifacts) return;
  download(`milestones_${lastArtifacts.filenameTag}.csv`, lastArtifacts.csvMilestones);
});
dlLbBtn.addEventListener("click", () => {
  if (!lastArtifacts) return;
  download(`leaderboard_${lastArtifacts.filenameTag}.csv`, lastArtifacts.csvLeaderboard);
});
</script>
</body>
</html>
